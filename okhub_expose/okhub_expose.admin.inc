<?php

// Global settings
global $default_standard_fields;
global $default_taxonomy_fields;
$default_standard_fields = array('post_title', 'post_content');
$default_taxonomy_fields = array('name', 'slug');


// Checks if it has to display the admin settings or if it has to initialize the plugin's data, etc.
function okhub_expose_admin_main() {
  if (!current_user_can( 'manage_options')) {
    wp_die(__('You do not have sufficient permissions to manage the plugin settings.'));
  }
  okhub_expose_render_form();
}

// Display registered error messages
function okhub_expose_admin_notices() {
  settings_errors('okhub_expose_options', FALSE, TRUE);
  idsapi_report_errors();
}

// Admin page.
function okhub_expose_general_page() {
?>
  <div class="wrap">
  <div id="icon-edit-pages" class="icon32"><br /></div>
  <div id="ids-logo"><a href="http://api.ids.ac.uk" target="_blank"><img src="http://api.ids.ac.uk/docs/wp-content/uploads/2012/01/KS_powered.gif"></a></div>
  <h2>OKHub Expose Plugin </h2>
  <br /><br />
  <u class="ids-category-list">
    <li class="cat-item"> <a href="<?php echo get_admin_url() . 'options-general.php?page=okhub_expose' ?>"><?php _e('Settings'); ?></a></li>
    <li class="cat-item"> <a href="<?php echo get_admin_url() . 'admin.php?page=okhub_expose_create_feeds' ?>"><?php _e('Feeds'); ?></a></li>
    <li class="cat-item"> <a href="<?php echo get_admin_url() . 'admin.php?page=okhub_expose_help' ?>"><?php _e('Help'); ?></a></li>
  </u>
  </div>
<?php
}

// Page to generate new feeds based on the content types and taxonomies selected in the settings page.
function okhub_expose_create_feeds_page() {
  $array_post_types = okhub_expose_get_post_types();
  $array_taxonomies = okhub_expose_get_taxonomies();
  $selected_types = idsapi_variable_get('okhub_expose', 'content_types', array());
  $selected_taxonomies = idsapi_variable_get('okhub_expose', 'taxonomies', array());
  foreach ($array_post_types as $type => $type_label) {
    if (isset($selected_types[$type])) {
      $select_types[$type] = $type_label;
    }
  }
  foreach ($array_taxonomies as $taxonomy => $taxonomy_label) {
    if (isset($selected_taxonomies[$taxonomy])) {
      $select_taxonomies[$taxonomy] = $taxonomy_label;
    }
  }
  $feed_assets_url = site_url() . '?feed=ids_assets'; 
  $feed_categories_url = site_url() . '?feed=ids_categories'; 
?>
  <div class="wrap">
  <div id="icon-tools" class="icon32"><br /></div>
  <h2><?php _e('OKHub Expose feeds'); ?></h2>
  <p>
  <b><?php _e('Create new feeds'); ?></b>
  <form id="okhub_expose_create_feed">
	<table class="form-table" id="content_types">
    <tr>
      <th scope="row"><b><?php _e('Feed URL'); ?></b></th>
      <td>
      <p class="description">
      <?php _e('Feed URL generated by the selections made below. Change the selections in order to generate a new URL.'); ?> </br>
      </p>
			<input type="hidden" id="okhub_expose_original_posts_url" value="<?php echo $feed_assets_url; ?>" />
			<input type="hidden" id="okhub_expose_original_categories_url" value="<?php echo $feed_categories_url; ?>" />
      <textarea id="okhub_expose_feed_url" rows="3" cols="90"><?php echo $feed_assets_url; ?></textarea></br>
      <button type="button" onclick="generateFeedUrl()">Generate new feed URL</button> 
      <button type="button" onclick="gotoFeed()">Go to feed</button></br>
      </td>
    </tr>
    <tr>
      <th scope="row"><?php _e('Number of elements in feed'); ?></th>
      <td>
			<input type="text" size="4" id="okhub_expose_num_items" value="<?php echo get_option('posts_per_rss'); ?>" />
      </td>
    </tr>
  </table>

	<table class="form-table" id="content_types">
    <tr>
      <th scope="row"><?php _e('Type of feed'); ?></th>
      <td>
      <?php echo ids_select_box('okhub_expose_type_feed', 'okhub_expose_type_feed', array('posts' => 'Posts', 'categories' => 'Categories'), array(), array('onchange' => 'changeFeedType()')); ?>
      </td>
    </tr>
  </table>

  <!---------------------------------------------- Posts ---------------------------------------------->
  <table class="form-table" id="okhub_expose_select_posts">
    <tr>
      <th scope="row"><?php _e('Content type'); ?></th>
      <td>
      <?php echo ids_select_box('okhub_expose_posts', 'okhub_expose_posts', $select_types, array(), array('onchange' => 'changeFeedFilters()')); ?>
      </td>
    </tr>
    <?php foreach (array_keys($select_types) as $content_type) { 
      $objects_taxonomies = get_object_taxonomies($content_type, 'objects');
      foreach($objects_taxonomies as $tax_name => $tax_object) { 
        if ($tax_object->show_ui) { ?>
        <tr class="okhub_expose_filters okhub_expose_filters_<?php echo $content_type;?>">
          <th scope="row"><?php printf(__('Filter by %s'), __($tax_object->label)); ?></th>
          <td>
            <?php wp_dropdown_categories(array('name' => 'okhub_expose_' . $tax_name . '[]', 'class' => 'okhub_expose_' . $content_type . '_taxonomy_select', 'id' => $content_type . '-' .$tax_name, 'taxonomy' => $tax_name, 'hierarchical' => $tax_object->hierarchical, 'hide_empty' => FALSE, 'orderby' => 'name')); ?><br/>
            <a href="javascript:deselectAll('<?php echo $content_type . '-' .$tax_name; ?>');"><?php _e('Deselect all'); ?></a>                
          </td>
        </tr>
      <?php }
        }
    } ?>
    <?php if (!empty($objects_taxonomies)) { ?>
    <tr>
      <th scope="row"><?php _e('Filters operator'); ?></th>
      <td>
      <?php echo ids_select_box('okhub_expose_posts_cats_op', 'okhub_expose_posts_cats_op', array('OR' => 'Posts matching any of the filters (OR)', 'AND' => 'Posts matching all the filters (AND)'), array('OR')); ?>
      <p class="description">
      <?php _e('Please note that this selection indicates how to join different filters.'); ?></br>
      <?php _e('Options within the same filter are considered as alternatives and posts matching at least one of them will be retrieved.'); ?> </br>
      </p>
      </td>
    </tr>
    <?php } ?>
  </table>

  <!---------------------------------------------- Categories ---------------------------------------------->
  <table class="form-table" id="okhub_expose_select_categories">
    <tr>
      <th scope="row"><?php _e('Taxonomy'); ?></th>
      <td>
      <?php echo ids_select_box('okhub_expose_categories', 'okhub_expose_categories', $select_taxonomies, array(), array('onchange' => 'changeFeedFilters()')); ?>
      </td>
    </tr>
  </table>

  </form>
  </p>
  </div>
<?php
}

function okhub_expose_help_page() {
?>
  <div class="wrap">
  <div id="icon-edit-comments" class="icon32 icon32-posts-page"><br /></div>
  <h2><?php _e('Help'); ?></h2>
  <p>
  <?php _e('The IDS KS API plugin allows access to IDS Knowledge Services content of thematically organised and hand selected academic research on poverty reduction in the developing world that is freely available to access online.'); ?>
  </p>
  <b><?php _e('OKHub Expose plugin'); ?></b>
  <p>
  <?php _e('This plugin allow to expose contributed content for the IDS KS Hub.'); ?>
  </p>
  <p>
  <?php _e('The following filters are called by the plugin:'); ?>
  </p>
  <ul>
  <li> <?php _e('exposed_tag($field, $type); - Alters field names to generate tags for posts and terms ($type can be a post type or taxonomy name).'); ?>
  <li> <?php _e('exposed_post_value($value, $field, $post_type); - Alters values for field name $tag in posts.'); ?>
  <li> <?php _e('exposed_term_value($value, $field, $taxonomy); - Alters values for field name $tag in taxonomy terms.'); ?>
  </ul>
  <p>
  <?php _e('If a mapping is defined for a post type or taxonomy\'s field, it will be applied before calling to the'); ?>
  <?php _e('exposed_post_tag_{$tag} or exposed_term_tag_{$tag} filters.'); ?>
  </p>
  <p>
  <?php _e('These filters are called *within the loop*, when generating the feeds.'); ?>
  </p>
<?php
}

// Render the plugin's main admin form.
function okhub_expose_render_form() {
  global $ids_categories;
  global $ids_assets;
  global $ids_datasets;
  global $default_standard_fields;
  global $default_taxonomy_fields;
  $select_post_types = okhub_expose_get_post_types();
  $select_taxonomies = okhub_expose_get_taxonomies();
  // Initialization of mappings. TODO: Generalize.
  $wp_post_fields_mappings = array('post_title' => 'title', 'post_content' => 'description');
  $ids_post_fields_mappings = $wp_post_fields_mappings + array('bridge_object_id' => 'object_id', 'eldis_object_id' => 'object_id');
  $wp_term_fields_mappings = array('name' => 'title', 'slug' => 'guid');
  $ids_term_fields_mappings = $wp_term_fields_mappings + array('bridge_object_id' => 'object_id', 'eldis_object_id' => 'object_id');
  $default_post_mappings = array();
  foreach (array_keys($select_post_types) as $post_type) {
    $default_post_mappings[$post_type] = $wp_post_fields_mappings;
  }
  foreach ($ids_assets as $asset) {
    $default_post_mappings['ids_'.$asset] = $ids_post_fields_mappings;
  }
  $default_term_mappings = array();
  foreach (array_keys($select_taxonomies) as $taxonomy) {
    $default_term_mappings[$taxonomy] = $wp_term_fields_mappings;
  }
  foreach ($ids_datasets as $dataset) {
    foreach ($ids_categories as $category) {
      $default_term_mappings[$dataset.'_'.$category] = $ids_term_fields_mappings;
    }
  }
  $default_mappings = $default_post_mappings + $default_term_mappings;
  $current_mappings = idsapi_variable_get('okhub_expose', 'field_mappings', $default_mappings);
	?>
  <div class="wrap">
	<div class="ids-wrap">
		<!-- Display Plugin Icon, Header, and Description -->
		<div class="icon32" id="icon-options-general"></div>
		<h2><?php _e('OKHub Expose Plugin Settings'); ?></h2>
		<p>
      <?php printf(__('This plugin exposes content to be contributed to the IDS KS Hub.')); ?></br>
      <?php $admin_feeds_url = get_admin_url() . 'admin.php?page=okhub_expose_create_feeds' ?>
      <?php printf(__('Multiple exposing URLs can be generated <a href="%s">in this page</a>, filtering content by several criteria.'), $admin_feeds_url); ?>
    </p>

    <!-- Beginning of the Plugin Options Form -->
		<form method="post" id="ids_expose_form" action="options.php" onSubmit="selectAllClass('okhub_expose-mappings-select')">
      <?php
          settings_fields('okhub_expose');
      ?>

    <div class="ui-tabs">
      <ul class="ui-tabs-nav">
        <li><a href="#content_types"><?php _e('Types of content'); ?></a></li>
        <li><a href="#mappings"><?php _e('Mappings'); ?></a></li>
      </ul>
      <h3><?php _e('Types of content'); ?></h3>
			<table class="form-table ui-tabs-panel" id="content_types">
        <tr>
          <td colspan="2">
            <p class="description">
            <?php _e('Please indicate the content that you want to make available to the exposer.'); ?><br>
            </p>
          </td>
        </tr>

        <!------------------------------------------------- EXPOSED POST TYPES ----------------------------------------->
        <tr>
          <th scope="row"><?php _e('Content types'); ?></th>
          <td>
            <p class="description">
            <?php _e('Please indicate, for each selected type of content, the fields that you would like to expose in addition to the standard Wordpress fields. Only fields with valid values will be exposed.'); ?> </br></br>
            </p>
            <?php $selected_types = idsapi_variable_get('okhub_expose', 'content_types', array()); ?>
            <?php foreach ($select_post_types as $post_type => $label) { ?>
              <label><input id="<?php echo $post_type; ?>" class="okhub_expose-content-types" name="okhub_expose_options[content_types][<?php echo $post_type; ?>]" type="checkbox" 
              <?php echo (isset($selected_types[$post_type]) ? 'checked="yes"' : ''); ?> onchange="changeFields();" /> <strong><?php _e($label); ?></strong></label></br>
              <div class="<?php echo 'fields-' . $post_type; ?>" style="border:1px solid grey;width:600px;">
                <table>
                <tr>
                <td>
                <i>Standard Wordpress fields</i></br>
                <?php
                // Standard fields. Some fields are always included (title, guid).
                $standard_fields = ids_get_default_fields($post_type);
                $var_name = 'standard_fields_' . $post_type;
                $select_id = 'okhub_expose_' . $var_name;
                $select_name = "okhub_expose_options[$var_name][]";
                echo ids_select_box($select_name, $select_id, $standard_fields, idsapi_variable_get('okhub_expose', $var_name, $default_standard_fields), array('multiple' => 'multiple'));
                ?>
                </br>
                <a href="javascript:selectAll('<?php echo $select_id; ?>');"><?php _e('Select all'); ?></a> / 
                <a href="javascript:deselectAll('<?php echo $select_id; ?>');"><?php _e('Deselect all'); ?></a>                
                </td>
                <td>
                <?php
                // Custom fields
                if ($custom_fields = ids_get_type_custom_fields($post_type)) {
                  echo '<i>'.__('Custom fields').'</i></br>';
                  $var_name = 'custom_fields_' . $post_type;
                  $select_id = 'okhub_expose_' . $var_name;
                  $select_name = "okhub_expose_options[$var_name][]";
                  echo ids_select_box($select_name, $select_id, $custom_fields, idsapi_variable_get('okhub_expose', $var_name, array()), array('multiple' => 'multiple'));
                  ?>
                  </br>
                  <a href="javascript:selectAll('<?php echo $select_id; ?>');"><?php _e('Select all'); ?></a> / 
                  <a href="javascript:deselectAll('<?php echo $select_id; ?>');"><?php _e('Deselect all'); ?></a>                
                <?php } ?>
                </td>
                </tr>
                </table>
              </div>
              </br>
            <?php } ?>
          </td>
        </tr>
        
        <!------------------------------------------------- EXPOSED TAXONOMIES ----------------------------------------->
        <tr>
          <th scope="row"><?php _e('Taxonomies'); ?></th>
          <td>
            <p class="description">
            <?php _e('Select the taxonomies that you would like to expose.'); ?></br>
            <?php _e('Please indicate, for each taxonomy, the fields that you would like to expose. Only fields with valid values will be exposed.'); ?> </br></br>
            </p>
            <?php $selected_taxonomies = idsapi_variable_get('okhub_expose', 'taxonomies', array()); ?>
            <?php foreach ($select_taxonomies as $taxonomy => $label) { ?>
              <label><input id="<?php echo $taxonomy; ?>" class="okhub_expose-content-types" name="okhub_expose_options[taxonomies][<?php echo $taxonomy; ?>]" type="checkbox" 
              <?php echo (isset($selected_taxonomies[$taxonomy]) ? 'checked="yes"' : ''); ?> onchange="changeFields();" /> <strong><?php _e($label); ?></strong></label></br>
              <!-- In the case of taxonomies, we only give the option to select fields for IDS taxonomies, as there is not a default way of implementing custom fields for taxonomies in Wordpress -->
              <?php // TODO: Generalise.
              //if ($taxonomy == 'eldis_countries' || $taxonomy == 'eldis_regions' || $taxonomy == 'eldis_themes' || $taxonomy == 'bridge_countries' || $taxonomy == 'bridge_regions' || $taxonomy == 'bridge_themes') { ?>
              <div class="<?php echo 'fields-' . $taxonomy; ?>" style="border:1px solid grey;width:600px;">
                <table>
                <tr>
                <td>
                <i>Standard Wordpress fields</i></br>
                <?php
                // Standard fields. Some fields are always included (title, guid).
                $standard_fields = ids_get_term_default_fields();
                $var_name = 'standard_fields_' . $taxonomy;
                $select_id = 'okhub_expose_' . $var_name;
                $select_name = "okhub_expose_options[$var_name][]";
                echo ids_select_box($select_name, $select_id, $standard_fields, idsapi_variable_get('okhub_expose', $var_name, $default_taxonomy_fields), array('multiple' => 'multiple'));
                ?>
                </br>
                <a href="javascript:selectAll('<?php echo $select_id; ?>');"><?php _e('Select all'); ?></a> / 
                <a href="javascript:deselectAll('<?php echo $select_id; ?>');"><?php _e('Deselect all'); ?></a>                
                </td>
                <td>
                <?php
                // Custom fields
                if ($custom_fields = ids_get_taxonomy_custom_fields($taxonomy)) {
                  echo '<i>'.__('Custom fields').'</i></br>';
                  $custom_fields = array_combine($custom_fields, $custom_fields);
                  natcasesort($custom_fields);
                  $var_name = 'custom_fields_' . $taxonomy;
                  $select_id = 'okhub_expose_' . $var_name;
                  $select_name = "okhub_expose_options[$var_name][]";
                  echo ids_select_box($select_name, $select_id, $custom_fields, idsapi_variable_get('okhub_expose', $var_name, array()), array('multiple' => 'multiple'));
                  ?>
                  </br>
                  <a href="javascript:selectAll('<?php echo $select_id; ?>');"><?php _e('Select all'); ?></a> / 
                  <a href="javascript:deselectAll('<?php echo $select_id; ?>');"><?php _e('Deselect all'); ?></a>                
                <?php } ?>
                </td>
                </tr>
                </table>
                <!--hr style="width:600px;margin-left:0;text-align:left;"-->
              </div>
              <?php // } ?>
              </br>
            <?php } ?>
          </td>
        </tr>
      </table>

      <!-- TODO: Generalize. Allow nested mappings -->
      <h3><?php _e('Mappings'); ?></h3>
      <table class="form-table ui-tabs-panel" id="mappings">
        <tr>
          <td colspan="2">
            <p class="description">
              <?php _e('Please indicate, for each field in the exposed types of content, if you would like to map it to a new XML element.'); ?>
            </p>
          </td>
        </tr>

        <!------------------------------------------------- MAPPINGS - POST TYPES ----------------------------------------->
        <?php foreach ($select_post_types as $post_type => $label) { ?>
        <tr class="<?php echo 'fields-' . $post_type; ?>">
          <th scope="row"><?php echo $label; ?></th>
          <td>
              <table id="<?php echo 'field-mappings-' . $post_type; ?>" style="border:1px solid grey">
                <tr>
                <td>
                <table style="border: 1px solid lightgrey";>
                <tr>
                  <td>
                  <p class="description"><?php _e("Standard Wordpress fields"); ?></p>
                  <?php
                  $select_mappings_id = 'select_field_mappings_'.$post_type;
                  $select_mappings_name = "okhub_expose_options[select_field_mappings][$post_type][]";
                  // Standard fields
                  $standard_fields = ids_get_default_fields($post_type);
                  $select_standard_fields = 'standard_fields_mappings_' . $post_type;
                  $input_new_field = 'new_standard_field_mapping_'.$post_type;
                  echo ids_select_box($select_standard_fields, $select_standard_fields, $standard_fields, array());
                  ?>
                  <p class="description">&nbsp;</p>              
                  </td>
                  <td>
                    <p class="description"><?php _e("Map to:"); ?></p>
                    <input type="text" size="16" id="<?php echo $input_new_field; ?>" value="" />
                    <p class="description">
                      <a href="javascript:addFieldMapping('<?php echo $select_standard_fields?>', '<?php echo $input_new_field?>', '<?php echo $select_mappings_id; ?>');"><?php _e('Add mapping'); ?> &rarr;</a>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                  
                  <?php
                  // Custom fields
                  if ($custom_fields = ids_get_type_custom_fields($post_type)) { ?>
                    <p class="description"><?php _e("Custom fields"); ?></p>
                    <?php
                    $select_custom_fields = 'custom_fields_mappings_' . $post_type;
                    $input_new_field = 'new_custom_field_mapping_'.$post_type;
                    echo ids_select_box($select_custom_fields, $select_custom_fields, $custom_fields, array());
                    ?>
                    <p class="description">&nbsp;</p>              
                    </td>
                    <td>
                      <p class="description"><?php _e("Map to:"); ?></p>
                      <input type="text" size="16" id="<?php echo $input_new_field?>" value="" />
                      <p class="description">
                        <a href="javascript:addFieldMapping('<?php echo $select_custom_fields?>', '<?php echo $input_new_field?>', '<?php echo $select_mappings_id; ?>');"><?php _e('Add mapping'); ?> &rarr;</a>
                      </p>
                  <?php } ?>
                  </td>
                </tr>
                </table>
                </td>
                <td>
                <select name="<?php echo $select_mappings_name?>" id="<?php echo $select_mappings_id?>" class="okhub_expose-mappings-select" size=8 multiple="multiple">
                <?php
                  if (isset($current_mappings[$post_type])) {
                    foreach ($current_mappings[$post_type] as $source => $destination) {
                      echo "<option name='$source' value='$source,$destination' >$source --> $destination</option>";
                    }
                  }
                ?>
                </select>            
                <p class="description">
                  <a href="javascript:removeMappings('<?php echo $select_mappings_id; ?>');">&larr; <?php _e('Remove selected'); ?></a>
                  </br>
                  <a href="javascript:selectAll('<?php echo $select_mappings_id; ?>');"><?php _e('Select all'); ?></a> /
                  <a href="javascript:deselectAll('<?php echo $select_mappings_id; ?>');"><?php _e('Deselect all'); ?></a>
                </p>
                </td>
                </tr>
                </table>
              </div>
            </td>
          </tr>
        <?php } ?>

        <!------------------------------------------------- MAPPINGS - TAXONOMIES ----------------------------------------->
        <?php foreach ($select_taxonomies as $taxonomy => $label) { ?>
        <tr class="<?php echo 'fields-' . $taxonomy; ?>">
          <th scope="row"><?php echo $label; ?></th>
          <td>
              <table id="<?php echo 'field-mappings-' . $taxonomy; ?>" style="border:1px solid grey">
                <tr>
                <td>
                <table style="border: 1px solid lightgrey";>
                <tr>
                  <td>
                  <p class="description"><?php _e("Standard Wordpress fields"); ?></p>
                  <?php
                  $select_mappings_id = 'select_field_mappings_'.$taxonomy;
                  $select_mappings_name = "okhub_expose_options[select_field_mappings][$taxonomy][]";
                  // Standard fields
                  $standard_fields = ids_get_term_default_fields();
                  $standard_fields = array_combine($standard_fields, $standard_fields);
                  natcasesort($standard_fields);
                  $select_standard_fields = 'standard_fields_mappings_' . $taxonomy;
                  $input_new_field = 'new_standard_field_mapping_'.$taxonomy;
                  echo ids_select_box($select_standard_fields, $select_standard_fields, $standard_fields, array());
                  ?>
                  <p class="description">&nbsp;</p>              
                  </td>
                  <td>
                    <p class="description"><?php _e("Map to:"); ?></p>
                    <input type="text" size="16" id="<?php echo $input_new_field; ?>" value="" />
                    <p class="description">
                      <a href="javascript:addFieldMapping('<?php echo $select_standard_fields?>', '<?php echo $input_new_field?>', '<?php echo $select_mappings_id; ?>');"><?php _e('Add mapping'); ?> &rarr;</a>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                  <?php
                  // Custom fields
                  if ($custom_fields = ids_get_taxonomy_custom_fields($taxonomy)) { ?>
                    <p class="description"><?php _e("Custom fields"); ?></p>
                    <?php
                    $custom_fields = array_combine($custom_fields, $custom_fields);
                    natcasesort($custom_fields);
                    $select_custom_fields = 'custom_fields_mappings_' . $taxonomy;
                    $input_new_field = 'new_custom_field_mapping_'.$taxonomy;
                    echo ids_select_box($select_custom_fields, $select_custom_fields, $custom_fields, array());
                    ?>
                    <p class="description">&nbsp;</p>              
                    </td>
                    <td>
                      <p class="description"><?php _e("Map to:"); ?></p>
                      <input type="text" size="16" id="<?php echo $input_new_field?>" value="" />
                      <p class="description">
                        <a href="javascript:addFieldMapping('<?php echo $select_custom_fields?>', '<?php echo $input_new_field?>', '<?php echo $select_mappings_id; ?>');"><?php _e('Add mapping'); ?> &rarr;</a>
                      </p>
                    <?php } ?>
                  </td>
                </tr>
                </table>
                </td>
                <td>
                <select name="<?php echo $select_mappings_name?>" id="<?php echo $select_mappings_id?>" class="okhub_expose-mappings-select" size=8 multiple="multiple">
                <?php
                  if (isset($current_mappings[$taxonomy])) {
                    foreach ($current_mappings[$taxonomy] as $source => $destination) {
                      echo "<option name='$source' value='$source,$destination' >$source --> $destination</option>";
                    }
                  }
                ?>
                </select>            
                <p class="description">
                  <a href="javascript:removeMappings('<?php echo $select_mappings_id; ?>');">&larr; <?php _e('Remove selected'); ?></a>
                  </br>
                  <a href="javascript:selectAll('<?php echo $select_mappings_id; ?>');"><?php _e('Select all'); ?></a> /
                  <a href="javascript:deselectAll('<?php echo $select_mappings_id; ?>');"><?php _e('Deselect all'); ?></a>
                </p>
                </td>
                </tr>
                </table>
              </div>
            </td>
          </tr>
        <?php } ?>

      </table>
    </div>	<!-- UI tabs -->	

    <p class="submit">
      <input name="okhub_expose_options[submit_save]" type="submit" class="button-primary" value="<?php _e('Save changes') ?>" />
    </p>
		</form>
  </div>
  </div>
  <?php
}

// Validate input.
function okhub_expose_validate_options($input) {
  $field_mappings = array();
  $error = FALSE;
  $error_message = '';
  if (isset($input['select_field_mappings'])) {
    foreach($input['select_field_mappings'] as $type => $mappings) {
      $field_mappings[$type] = array();
      foreach ($mappings as $mapping) {
        list($source, $destination) = explode(',', $mapping);
        if (okhub_expose_valid_xml_name($destination)) {
          $field_mappings[$type][$source] = $destination;
        }
        else {
          $error = TRUE;
          $error_message .= sprintf(__(' %s is not a valid XML tag.'), $destination);
        }
      }
    }  
  }
  if ($field_mappings) {
    $input['field_mappings'] = $field_mappings;
  }
  if ($error) {
    $input['setup_done'] = FALSE;
    add_settings_error('idsimport_options', 'idsimport_errors', $error_message);
  }
  else {
    $input['setup_done'] = TRUE;
  }
  return $input;
}

// Validate XML mapped tags.
// TODO: Change to allow attributes.
function okhub_expose_valid_xml_name($qname) {
  $prefixedName = (!strpos($qname, ':') ? 'prefix:' : '') . $qname;
  try {
    new DOMElement($prefixedName, NULL, 'uri:ns');
    return TRUE;
  } catch (DOMException $e) {
    return FALSE;
  }
}


